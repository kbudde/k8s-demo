#@ load("@ytt:data", "data")
#@ domain = "python." + data.values.shared.domain
#@ traefikLB = "lb." + data.values.shared.domain
---
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: gitpod-1
  annotations:
    external-dns.alpha.kubernetes.io/target: #@ traefikLB
    kubernetes.io/ingress.class: traefik
spec:
  entryPoints:
  - websecure
  routes:
  - kind: Rule
    match: #@ "Host(`{}`)".format(domain)
    priority: 10
    services:
      - name: gitpod-1
        port: 3000
        scheme: http

    middlewares:
      - name: gitpod-1
      - name: set-project

---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
    name: set-project
spec:
  plugin:
    traefik-plugin-query-modification:
      NewValue: /home/workspace/projects
      ParamName: folder
      Type: modify
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: gitpod-1
spec:
  basicAuth:
    secret: gitpod-1
---
apiVersion: v1
kind: Secret
metadata:
  name: gitpod-1
stringData:
  users: <path:static/user.yaml#gitpod-1>